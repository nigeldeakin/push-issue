workflows:
  - name: all
    pipelines:
      - name: pipeline1
      - name: pipeline2
        requires:
          - pipeline1

pipeline1: 
  box: golang
  steps:
    - script:    
        name: Dummy step
        code: This is just a dummy step

pipeline2:
  box: golang
  steps:
    - script:    
        name: Check environment variables
        code: |
          if [[ -z "$USERNAME" ]]; then
            echo Environment variable \$USERNAME is not set
            return 1
          fi   
          if [[ -z "$PASSWORD" ]]; then
            echo Environment variable \$PASSWORD is not set
            return 1
          fi  
    - script:
        name: Unit tests
        code: go test ./...     
    - internal/docker-build: 
        dockerfile: Dockerfile 
        image-name: my-new-image # name used to refer to this image until it's pushed   
    - internal/docker-run:
        image: my-new-image
        name: myTestContainer     
    - script: 
        name: Test the container
        code: |
            if curlOutput=`curl -s myTestContainer:5000`; then 
                if [ "$curlOutput" == "Hello World!!" ]; then
                    echo "Test passed: container gave expected response"
                else
                    echo "Test failed: container gave unexpected response: " $curlOutput
                    exit 1
                fi   
            else 
                echo "Test failed: container did not respond"
                exit 1
            fi        
    - internal/docker-kill:
        name: myTestContainer               
    - internal/docker-push: 
        image-name: my-new-image
        username: $USERNAME 
        password: $PASSWORD 
        repository: docker.io/$USERNAME/push-issue
        tag: latest
